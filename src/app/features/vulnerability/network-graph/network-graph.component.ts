import {
  Component,
  ElementRef,
  inject,
  OnInit,
  output,
  viewChild,
  AfterViewInit,
} from '@angular/core';
import { NgxGraphModule, NgxGraphZoomOptions } from '@swimlane/ngx-graph';
import { Subject } from 'rxjs';
import { VulnerabilityStore, PopoverPosition } from '../../../core/services';
import { GraphNode } from '../../../core/models';

@Component({
  selector: 'app-network-graph',
  standalone: true,
  imports: [NgxGraphModule],
  template: `
    <div class="graph-container" #graphContainer>
      <ngx-graph
        class="chart-container"
        [links]="store.graphEdges()"
        [nodes]="store.graphNodes()"
        [zoomToFit$]="zoomToFit$"
        [center$]="center$"
        [enableZoom]="true"
        [autoZoom]="true"
        [autoCenter]="true"
        layout="dagre"
      >
        <!-- Node Template -->
        <ng-template #nodeTemplate let-node>
          <svg:g
            class="node-group"
            (click)="onNodeClick($event, node)"
          >
            <!-- Node circle -->
            <svg:circle
              [attr.r]="30"
              [attr.fill]="getNodeColor(node)"
              class="node-circle"
            />

            <!-- Badge indicator -->
            @if (node.data?.risk === 'critical') {
              <svg:g transform="translate(18, -18)">
                <svg:circle r="10" fill="#dc2626" />
                <svg:text
                  text-anchor="middle"
                  dominant-baseline="central"
                  fill="white"
                  font-size="10"
                  font-weight="bold"
                >
                  2
                </svg:text>
              </svg:g>
            }

            <!-- Server icon (simplified) -->
            <svg:rect
              x="-10"
              y="-8"
              width="20"
              height="16"
              rx="2"
              fill="white"
              opacity="0.9"
            />
            <svg:line x1="-8" y1="-3" x2="8" y2="-3" stroke="#94a3b8" stroke-width="1" />
            <svg:line x1="-8" y1="2" x2="8" y2="2" stroke="#94a3b8" stroke-width="1" />

            <!-- Label below node -->
            <svg:text
              y="50"
              text-anchor="middle"
              class="node-label"
              fill="var(--color-text-primary)"
              font-size="12"
            >
              {{ node.label }}
            </svg:text>
          </svg:g>
        </ng-template>

        <!-- Link Template -->
        <ng-template #linkTemplate let-link>
          <svg:g class="edge-group">
            <svg:path
              [attr.d]="link.line"
              stroke="#cbd5e1"
              stroke-width="2"
              fill="none"
              stroke-dasharray="5,5"
            />
          </svg:g>
        </ng-template>
      </ngx-graph>
    </div>
  `,
  styles: `
    :host {
      display: block;
      width: 100%;
      height: 100%;
    }

    .graph-container {
      width: 100%;
      height: 100%;
      min-height: 15rem;
      background-color: var(--color-bg-secondary);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .chart-container {
      width: 100%;
      height: 100%;
    }

    .node-group {
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .node-group:hover {
      transform: scale(1.05);
    }

    .node-circle {
      stroke: white;
      stroke-width: 3;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    .node-label {
      font-family: var(--font-sans);
      font-weight: 500;
      pointer-events: none;
    }

    .edge-group {
      pointer-events: none;
    }
  `,
})
export class NetworkGraphComponent implements OnInit, AfterViewInit {
  store = inject(VulnerabilityStore);

  nodeClick = output<{ node: GraphNode; position: PopoverPosition }>();

  graphContainer = viewChild<ElementRef<HTMLDivElement>>('graphContainer');

  zoomToFit$ = new Subject<NgxGraphZoomOptions>();
  center$ = new Subject<boolean>();

  ngOnInit(): void {
    // Initial setup
  }

  ngAfterViewInit(): void {
    setTimeout(() => {
      this.zoomToFit$.next({ autoCenter: true, force: true });
      this.center$.next(true);
    }, 100);
  }

  getNodeColor(node: GraphNode): string {
    const colorMap: Record<string, string> = {
      critical: '#fee2e2',
      high: '#ffedd5',
      medium: '#fef9c3',
      low: '#dcfce7',
    };
    return colorMap[node.data?.risk] || '#e2e8f0';
  }

  onNodeClick(event: MouseEvent, node: GraphNode): void {
    event.stopPropagation();

    const container = this.graphContainer()?.nativeElement;
    if (!container) return;

    const rect = container.getBoundingClientRect();
    const position: PopoverPosition = {
      x: event.clientX - rect.left,
      y: event.clientY - rect.top,
    };

    this.store.selectNode(node, position);
    this.nodeClick.emit({ node, position });
  }
}
