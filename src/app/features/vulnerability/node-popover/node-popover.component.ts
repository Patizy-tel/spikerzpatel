import { Component, computed, HostListener, inject } from '@angular/core';
import { MatIconModule } from '@angular/material/icon';
import { VulnerabilityStore } from '../../../core/services';
import { TagBadgeComponent } from '../../../shared/components';

@Component({
  selector: 'app-node-popover',
  standalone: true,
  imports: [MatIconModule, TagBadgeComponent],
  template: `
    @if (store.isPopoverOpen() && store.selectedNode()) {
      <div
        class="popover-backdrop"
        (click)="store.closePopover()"
      ></div>
      <div
        class="popover"
        [style.left.px]="popoverStyle().left"
        [style.top.px]="popoverStyle().top"
        (click)="$event.stopPropagation()"
      >
        <div class="popover-header">
          <div class="icon-wrapper">
            <mat-icon>dns</mat-icon>
          </div>
          <div class="header-content">
            <div class="asset-name">{{ nodeData()?.name }}</div>
            <div class="asset-ip">{{ nodeData()?.ipAddress }}</div>
          </div>
        </div>

        @if (nodeData()?.tags?.length) {
          <div class="tags-section">
            <div class="section-label">Lorem:</div>
            <div class="tags-row">
              @for (tag of nodeData()!.tags; track tag.label) {
                <app-tag-badge [tag]="tag" />
              }
            </div>
          </div>
        }

        <div class="ip-section">
          <div class="section-label">Loremipsum</div>
          <div class="ip-list">
            <span class="ip-item info">Lorem</span>
            <span class="ip-value">1234,5678</span>
          </div>
        </div>
      </div>
    }
  `,
  styles: `
    .popover-backdrop {
      position: fixed;
      inset: 0;
      z-index: 100;
    }

    .popover {
      position: absolute;
      z-index: 101;
      background-color: var(--color-bg-primary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--color-border);
      padding: var(--spacing-md);
      min-width: 14rem;
      max-width: 18rem;
      animation: popover-in 0.15s ease-out;
    }

    @keyframes popover-in {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .popover-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--color-border);
    }

    .icon-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 2.25rem;
      height: 2.25rem;
      background-color: #fee2e2;
      color: var(--color-critical);
      border-radius: var(--radius-md);
    }

    .header-content {
      display: flex;
      flex-direction: column;
    }

    .asset-name {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--color-text-primary);
    }

    .asset-ip {
      font-size: 0.75rem;
      color: var(--color-text-muted);
    }

    .tags-section,
    .ip-section {
      margin-top: var(--spacing-sm);
    }

    .section-label {
      font-size: 0.75rem;
      color: var(--color-text-secondary);
      margin-bottom: var(--spacing-xs);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .section-label::before {
      content: '';
      display: inline-block;
      width: 0.75rem;
      height: 0.75rem;
      background-color: var(--color-bg-tertiary);
      border-radius: var(--radius-sm);
    }

    .tags-row {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-xs);
    }

    .ip-list {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .ip-item {
      font-size: 0.75rem;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
    }

    .ip-item.info {
      color: var(--color-info);
      background-color: #dbeafe;
    }

    .ip-value {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text-primary);
    }
  `,
})
export class NodePopoverComponent {
  store = inject(VulnerabilityStore);

  nodeData = computed(() => this.store.selectedNode()?.data);

  popoverStyle = computed(() => {
    const position = this.store.popoverPosition();
    if (!position) return { left: 0, top: 0 };

    return {
      left: position.x + 20,
      top: position.y - 50,
    };
  });

  @HostListener('document:keydown.escape')
  onEscape(): void {
    this.store.closePopover();
  }
}
