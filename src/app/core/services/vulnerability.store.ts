import { Injectable, computed, signal } from '@angular/core';
import { Asset, GraphData, GraphNode, RiskSummary, Vulnerability } from '../models';
import {
  MOCK_ASSETS,
  MOCK_GRAPH_DATA,
  MOCK_RISK_SUMMARY,
  MOCK_VULNERABILITY,
} from '../data/mock-data';

export interface PopoverPosition {
  x: number;
  y: number;
}

@Injectable({
  providedIn: 'root',
})
export class VulnerabilityStore {
  // Private writeable signals
  private readonly _vulnerability = signal<Vulnerability | null>(MOCK_VULNERABILITY);
  private readonly _assets = signal<Asset[]>(MOCK_ASSETS);
  private readonly _graphData = signal<GraphData>(MOCK_GRAPH_DATA);
  private readonly _riskSummary = signal<RiskSummary>(MOCK_RISK_SUMMARY);
  private readonly _selectedNode = signal<GraphNode | null>(null);
  private readonly _popoverPosition = signal<PopoverPosition | null>(null);
  private readonly _isPopoverOpen = signal<boolean>(false);
  private readonly _activeSidebarItem = signal<string>('item-4');

  // Public readonly signals
  readonly vulnerability = this._vulnerability.asReadonly();
  readonly assets = this._assets.asReadonly();
  readonly graphData = this._graphData.asReadonly();
  readonly riskSummary = this._riskSummary.asReadonly();
  readonly selectedNode = this._selectedNode.asReadonly();
  readonly popoverPosition = this._popoverPosition.asReadonly();
  readonly isPopoverOpen = this._isPopoverOpen.asReadonly();
  readonly activeSidebarItem = this._activeSidebarItem.asReadonly();

  // Computed signals
  readonly criticalAssets = computed(() =>
    this._assets().filter((asset) => asset.risk === 'critical')
  );

  readonly affectedAssetsCount = computed(() => this._vulnerability()?.affectedAssets.length ?? 0);

  readonly graphNodes = computed(() => this._graphData().nodes);
  readonly graphEdges = computed(() => this._graphData().edges);

  // Actions
  selectNode(node: GraphNode | null, position?: PopoverPosition): void {
    this._selectedNode.set(node);
    if (node && position) {
      this._popoverPosition.set(position);
      this._isPopoverOpen.set(true);
    } else {
      this._isPopoverOpen.set(false);
      this._popoverPosition.set(null);
    }
  }

  closePopover(): void {
    this._isPopoverOpen.set(false);
    this._selectedNode.set(null);
    this._popoverPosition.set(null);
  }

  setActiveSidebarItem(itemId: string): void {
    this._activeSidebarItem.set(itemId);
  }

  // For future API integration
  loadVulnerability(id: string): void {
    // TODO: Replace with HTTP call
    console.log('Loading vulnerability:', id);
    this._vulnerability.set(MOCK_VULNERABILITY);
  }
}
